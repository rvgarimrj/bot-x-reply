<claude-mem-context>
# Recent Activity

<!-- This section is auto-generated by claude-mem. Edit content outside the tags. -->

*No recent activity*
</claude-mem-context>

# Bot-X-Reply

Sistema inteligente de engajamento no X (Twitter) via replies estratégicos.

---

## REGRAS IMPORTANTES (SEMPRE RESPEITAR)

### Estilo de Reply do Usuário (@garimdreaming)
- **SEMPRE INFORMATIVO** - Demonstrar conhecimento do assunto
- **SEMPRE PESQUISAR** antes de sugerir replies
- **Tom**: Descontraído mas profissional
- **Objetivo**: Agregar valor com informação que o autor não mencionou
- **NUNCA**: Respostas genéricas, provocações vazias, perguntas óbvias tipo "o que é estranho?"

### Sistema de Pesquisa (OBRIGATÓRIO)
Antes de gerar replies, o sistema DEVE:
1. Identificar o tópico do tweet
2. Pesquisar contexto e dados relevantes
3. Usar informações pesquisadas para gerar replies informativos

### Exemplo de Reply BOM vs RUIM
```
RUIM: "O que exatamente está estranho?"
RUIM: "Estranho virou buzzword"
BOM: "Ratio ouro/prata acima de 80:1 historicamente sugere prata 'barata'. DXY forte + Fed hawkish = pressão em commodities."
```

### Chrome - Funcionar com Tela Bloqueada
O Chrome DEVE ser iniciado com estas flags para não dar timeout:
- `--disable-background-timer-throttling`
- `--disable-backgrounding-occluded-windows`
- `--disable-renderer-backgrounding`

App Nap DEVE estar desativado:
```bash
defaults write com.google.Chrome NSAppSleepDisabled -bool YES
```

### Timeout do Puppeteer
- `protocolTimeout`: 120000ms (não 60000)
- `page.setDefaultTimeout`: 60000ms
- Retry automático: 3 tentativas

---

## Arquitetura

- **Telegram Bot** (`@garim_x_reply_bot`): Interface de aprovação
- **Claude API**: Geração de replies com detecção de idioma
- **Playwright MCP**: Automação do browser para postar

## Modos de Operação

### Modo A (On-Demand)
1. Usuário envia URL de tweet no Telegram
2. Claude extrai texto e gera 3 opções de reply
3. Usuário aprova/edita
4. Claude Code posta via Playwright MCP

### Modo B (Proativo)
1. Daemon busca tweets de contas configuradas
2. Notifica usuário no Telegram
3. Mesmo fluxo de aprovação

## Estrutura

```
src/
├── claude.js      # Geração de replies (usa Sonnet para custo)
├── telegram.js    # Interface Telegram
├── browser.js     # Instruções para Playwright MCP
└── finder.js      # Busca e filtragem de tweets

scripts/
├── reply-bot.js   # Bot principal (Telegram listener)
└── search-daemon.js # Busca proativa (Modo B)

config/
├── profile.json   # Expertise e estilo do usuário
└── accounts.json  # Contas para monitorar
```

## Executar via Playwright MCP

Quando o bot gera instruções, execute no Claude Code:

```
mcp__playwright__browser_navigate("URL")
mcp__playwright__browser_snapshot
mcp__playwright__browser_click("seletor")
mcp__playwright__browser_type("texto")
mcp__playwright__browser_take_screenshot
```

## Limites de Segurança

- Max 10 replies/dia
- Intervalo 15min-2h entre replies
- Sempre aprovar manualmente
- Detecta idioma automaticamente

## Subir Serviços (se caírem ou após reiniciar)

### 1. Chrome do Bot (modo debug)
```bash
# Mata Chrome do bot se estiver travado
pkill -9 -f "chrome-bot-profile"

# Inicia Chrome com flags anti-suspensão
"/Applications/Google Chrome.app/Contents/MacOS/Google Chrome" \
  --remote-debugging-port=9222 \
  --user-data-dir="$HOME/.chrome-bot-profile" \
  --no-first-run \
  --disable-background-timer-throttling \
  --disable-backgrounding-occluded-windows \
  --disable-renderer-backgrounding \
  "https://x.com" &
```

### 2. Bot Telegram
```bash
cd /Users/user/AppsCalude/Bot-X-Reply
node scripts/reply-bot.js &
```

### 3. Daemon de Busca
```bash
cd /Users/user/AppsCalude/Bot-X-Reply
node scripts/search-daemon.js &
```

### 4. Desativar App Nap (se necessário)
```bash
defaults write com.google.Chrome NSAppSleepDisabled -bool YES
```

### Verificar se está rodando
```bash
# Chrome
curl -s http://127.0.0.1:9222/json/version | head -1

# Bot e Daemon
pgrep -f "reply-bot.js" && echo "Bot OK"
pgrep -f "search-daemon.js" && echo "Daemon OK"
```

### LaunchAgents (auto-start)
Os serviços iniciam automaticamente via launchd:
- `com.botxreply.setup.plist` - Desativa App Nap
- `com.botxreply.chrome.plist` - Chrome modo debug
- `com.botxreply.bot.plist` - Bot Telegram
- `com.botxreply.daemon.plist` - Daemon de busca

---

## Histórico de Melhorias (Guia de Referência)

### 2026-01-30: Correções Críticas

#### 1. Timeout do Chrome com Tela Bloqueada
**Problema**: Chrome dava timeout quando a tela do Mac estava bloqueada.
**Solução**:
- Aumentar `protocolTimeout` de 60s para 120s
- Adicionar retry automático (3 tentativas)
- Flags anti-suspensão no Chrome
- Desativar App Nap: `defaults write com.google.Chrome NSAppSleepDisabled -bool YES`

#### 2. Sistema de Pesquisa Informativa
**Problema**: Replies genéricos tipo "o que é estranho?" sem contexto.
**Solução**:
- Novo módulo `src/research.js`
- Identifica tópico do tweet antes de gerar
- Pesquisa dados e contexto relevantes
- Gera replies informativos com dados reais

#### 3. Fallback Puppeteer quando API Falha
**Problema**: Quando API do X dá erro 429, sistema gerava replies errados baseado só no username.
**Solução**:
- Se API falhar → Tenta Puppeteer
- Se Puppeteer falhar → Pede texto manual
- Fluxo: API → Puppeteer → Manual

#### 4. Conflito de Instâncias Telegram
**Problema**: Erro "409 Conflict: terminated by other getUpdates request"
**Solução**:
- Descarregar LaunchAgents antes de iniciar manualmente
- `launchctl unload ~/Library/LaunchAgents/com.botxreply.*.plist`
- Manter apenas UMA instância do bot rodando

### Checklist de Problemas Comuns

| Problema | Causa | Solução |
|----------|-------|---------|
| Timeout Chrome | Tela bloqueada | Verificar flags anti-suspensão |
| Replies genéricos | Sem texto do tweet | Verificar extração (API ou Puppeteer) |
| Erro 429 | Rate limit X | Aguardar 15-30min ou usar Puppeteer |
| Conflito Telegram | Múltiplas instâncias | Matar todos e iniciar um só |
| "Não consegui acessar" | API + Puppeteer falharam | Colar texto manualmente |